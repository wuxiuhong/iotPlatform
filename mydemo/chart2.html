<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/echarts.js"></script>
    <style>
        body {
            background-color: #292c4a;

            color: #0b415d;
        }

        .top-row {
            height: 40px;
            line-height: 40px;
        }

        .col1 {
            width: auto;
            font-size: 14px;
            float: left;
            letter-spacing: 2px;
        }

        .col1 img {
            vertical-align: middle;
        }

        .obj {
            clear: both;
            height: 0px;
            width: 100%;
            min-width: 300px;
            border: 1px solid rgba(24, 174, 156, 0.5);

            border-radius: 0 50% 50% 0;
        }

        .infomore {
            margin-top: 13px;
            width: 16px;
            height: 16px;
            line-height: 16px;
            border-radius: 10px;
            background-color: rgba(254, 254, 254, .5);;
            float: right;
            text-align: center;
            color: rgba(0, 0, 0, .5);
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="mainChart2" style="width: 100%;height:400px;"></div>

</body>
</html>
<script src="js/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>

    var self = {
        ctx: {
            $: $,
            echarts: echarts,
            eventMessage:{
                $emit:function () {

                },
                $on:function () {

                }
            }
        }
    };

    self.data = {
        da: {},
        option: {},
        a: 1,
        myChart:{},
        n: 1,
        curmin: 0,
        oldData : [],
        firstDate:""
    };


    self.onInit = function () {
        self.data.option = {
            title: {
                text: '刀具衰退趋势图',
                left: '‘0%',
                top: '0%',
                textStyle: {
                    color: 'rgba(255,255,255,0.5)',
                    fontStyle: 'normal',
                    fontFamily: 'sans-serif',

                    fontSize: 14
                }
            },
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    params = params[0];

                    return "磨损量  <span style='color:#01c6fd' >" + params.value[1] + "mm</span>";
                },
                axisPointer: {
                    type: 'cross',
                    animation: false,
                    label: {
                        backgroundColor: '#505765'
                    }
                },
                textStyle: {
                    color: 'rgba(255,255,255,0.5)'
                }
            },

            xAxis: {
                type: 'value',
                boundaryGap: false,
                name: '(mins)',
                nameGap: 20,
                splitNumber: 16,
                axisLine: {
                    lineStyle: {
                        color: 'rgba(255,255,255,0.5)'
                    }
                },
                axisLabel: {
                    interval: 5
                },
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                name: '磨损量（mm）',
                nameTextStyle: {
                    color: '#399fae',
                    fontSize: '16px'
                },
                nameGap: 30,
                axisTick: {
                    length: '0'
                },
                axisLine: {
                    lineStyle: {
                        color: 'rgba(255,255,255,0.5)'

                    }
                },
            },
            grid: {
                left: 36,
                top: 90
            },
            visualMap: {
                top: 10,
                right: 10,
                pieces: [{
                    gt: 0,
                    lte: 0.2,
                    color: '#E04F23'
                }, {
                    gt: 0.2,
                    lte: 0.4,
                    color: '#EAB62A'
                }, {
                    gt: 0.4,
                    lte: 1,
                    color: '#01c5fd'
                }],
                outOfRange: {
                    color: '#999'
                },
                show: false
            },
            color: ['#E04F23', '#EAB62A', '#01c5fd'],
            series: [
                {
                    data: [],
                    type: 'line',
                    showSymbol: false,
                    symbolSize: 1,
                    smooth: true,
                    itemStyle: {
                        normal: {
                            borderWidth: 3,
                            borderColor: 'white',
                            color: 'blue'
                        }
                    },
                    markLine: {
                        data: [{name: '最小值', xAxis: 0}],
                        lineStyle: {
                            type: 'solid',
                            color: '#000'
                        },
                        symbol: '',
                        label: {
                            show: false
                        }
                    }
                },
                {
                    data: [],
                    type: 'line',
                    symbol: 'none',
                    smooth: true,
                    itemStyle: {
                        normal: {
                            color: '#20aefc',
                            show: false
                        }
                    },
                    lineStyle: {
                        normal: {
                            width: 4,
                            type: 'dashed'
                        }
                    }
                },
                {
                    name: '低故障率',
                    type: 'line',
                    animation: false,
                    areaStyle: {
                        normal: {}
                    },
                    lineStyle: {
                        normal: {
                            width: 3
                        }
                    },
                    markArea: {
                        data: [[{
                            yAxis: '0'
                        }, {
                            yAxis: '0.2'
                        }]]
                    },

                }, {
                    name: '中等故障率',
                    type: 'line',
                    animation: false,
                    areaStyle: {
                        normal: {}
                    },
                    lineStyle: {
                        normal: {
                            width: 1
                        }
                    },
                    markArea: {
                        data: [[{
                            yAxis: '0.2'
                        }, {
                            yAxis: '0.4'
                        }]]
                    }
                }, {
                    name: '高故障率',
                    type: 'line',
                    animation: false,
                    areaStyle: {
                        normal: {}
                    },
                    lineStyle: {
                        normal: {
                            width: 1
                        }
                    },
                    markArea: {
                        data: [[{
                            yAxis: '0.4'
                        }, {
                            yAxis: '1'
                        }]]
                    }
                }]
        };
        self.data.myChart = self.ctx.echarts.init(document.getElementById('mainChart2'));

        setInterval(function () {
            var datanow = self.getData();
            var datapre = "[" + (datanow - 0.02) + "," + (datanow - 0.04) + "," + (datanow - 0.06) + "]";
            var data = [
                {
                    v: '2018-06-10 12:19:20',
                    t: 1528358866224,
                    k: {o: "tool_start_time", l: "tool_start_time"}
                },
                {
                    v: self.getDatestr(),
                    t: 1528358866224,
                    k: {o: "tool_end_time", l: "tool_end_time"}
                },
                {
                    v: datanow,
                    t: 1528358866224,
                    k: {o: "tool_wear", l: "tool_wear"}
                },
                {
                    v: datapre,
                    t: 1528358866224,
                    k: {o: "tool_wear_prid", l: "tool_wear_prid"}
                },
                {
                    v: 0,
                    t: 1528358866224,
                    k: {o: "tool_alarm", l: "tool_alarm"}
                },
                {
                    v: 1,
                    t: 1528358866224,
                    k: {o: "tool_warn", l: "tool_warn"}
                },
                {
                    v: 0.4,
                    t: 1528358866224,
                    k: {o: "tool_warn_thres", l: "tool_warn_thres"}
                },
                {
                    v: 0.2,
                    t: 1528358866224,
                    k: {o: "tool_alarm_thres", l: "tool_alarm_thres"}
                }
            ];
            if (self.data.a < 0) {
                self.data.a = 1;
                self.data.oldData = [];
                self.data.myChart.resize();
            } else {
                self.onDataUpdated(data);
            }
        }, 2000);
    };

    self.onDataUpdated = function (data) {
        var minutes = 0;
        self.ctx.$.each(data, function (i, obj) {
            self.data.da[obj.k.o] = obj.v;
        });

        if (self.data.oldData.length == 0) {
            self.data.oldData.push([0, self.data.da.tool_wear]);
            self.data.firstDate = self.data.da.tool_end_time;
        }
        else {
            var minutes = self.getMinsDiff(self.data.da.tool_end_time, self.data.firstDate);
            self.data.oldData.push([minutes, self.data.da.tool_wear]);
        }
        self.data.curmin = minutes;
        var tool_wear_prid = eval("(" + self.data.da.tool_wear_prid + ")");
        var arr = [];
        arr.push([self.data.curmin, self.data.da.tool_wear]);
        arr.push([self.data.curmin + 1, tool_wear_prid[0]]);
        arr.push([self.data.curmin + 2, tool_wear_prid[1]]);
        arr.push([self.data.curmin + 3, tool_wear_prid[2]]);

        self.data.option.series[0].data = self.data.oldData;
        self.data.option.series[1].data = arr;

        self.data.option.visualMap.pieces[0].lte = self.data.da.tool_alarm_thres;
        self.data.option.visualMap.pieces[1].gt = self.data.da.tool_alarm_thres;
        self.data.option.visualMap.pieces[1].lte = self.data.da.tool_warn_thres;
        self.data.option.visualMap.pieces[2].gt = self.data.da.tool_warn_thres;

        self.data.option.series[2].markArea.data[0][1].yAxis = self.data.da.tool_alarm_thres;
        self.data.option.series[3].markArea.data[0][0].yAxis = self.data.da.tool_alarm_thres;
        self.data.option.series[3].markArea.data[0][1].yAxis = self.data.da.tool_warn_thres;
        self.data.option.series[4].markArea.data[0][0].yAxis = self.data.da.tool_warn_thres;


        self.data.option.series[0].markLine.data[0].xAxis = minutes;
        self.data.myChart.setOption(self.data.option, true);
    };

    self.onResize = function () {
        self.data.myChart.resize();
    };

    self.onDestroy = function () {

    };

    self.getMinsDiff = function (date1, date2) {
        var date = new Date(date1).getTime() - new Date(date2).getTime();
        var diffmins = date / (60 * 1000);
        return diffmins;
    };

    self.getDatestr = function () {
        var date = new Date("2018-06-10 12:20:20");
        date.setMinutes(date.getMinutes() + self.data.n++);
        return date;
    };

    self.getData = function () {
        self.data.a = self.data.a - 0.02;
        return self.data.a;
    };

    self.onInit();

</script>